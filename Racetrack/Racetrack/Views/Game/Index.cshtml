@{
	ViewBag.Title = "Game";
}
<h2>Racetrack</h2>
<div class="container">
	<input type="text" id="message"/>
	<input type="button" id="sendmessage" value="Send"/>
	<input type="hidden" id="displayname"/>
	<pre id="world"></pre>
</div>
@section scripts {
	<!--Script references. -->
	<!--Reference the jQuery library. -->
	<script src="../../Scripts/jquery-3.1.1.min.js"></script>
	<!--Reference the SignalR library. -->
	<script src="../../Scripts/jquery.signalR-2.2.1.min.js"></script>
	<!--Reference the autogenerated SignalR hub script. -->
	<script src="~/signalr/hubs"></script>
	<!--Add script to update the page and send messages.-->
	<script type="text/javascript">
		$(function() {
			var map;

			function showWorld() {
				$('#world').html('');
				for (var i = 0; i < map.length; ++i) {
					for (var j = 0; j < map[i].length; ++j) {
						$('#world').append(map[i][j] + ' ');
					}
					$('#world').append('\n');
				}
			};

			var game = $.connection.gameHub;

			game.client.showMap = function(worldModel) {
				map = worldModel.Map.slice();
				showWorld();
			};

			game.client.showMovements = function(round, name, prevPos, curPos) {
				map[prevPos.Y][prevPos.X] = 0;
				map[curPos.Y][curPos.X] = 2;
				console.log(round +
					': ' +
					name +
					' Moved from (' +
					prevPos.X +
					', ' +
					prevPos.Y +
					') to (' +
					curPos.X +
					', ' +
					curPos.Y +
					')');
				showWorld();
			};
			var isCrashed = false;
			game.client.crashMyCar = function(round, name) {
				document.location.href = "/";
				alert("You lose :(");
				isCrashed = true;
				document.getElementById('sendmessage').disabled = true;
			};
			game.client.crashOtherCar = function(round, name) {
				$('#world')
					.append('<li><strong>' +
						round +
						': ' +
						name +
						'</strong> Crashed</li>');
			};
			game.client.beginNextRound = function() {
				if (!isCrashed) {
					document.getElementById('sendmessage').disabled = false;
				}
			};
			game.client.showEndOfGame = function(isWinner) {
				if (isWinner) {
					document.location.href = "/";
					alert("You win!");
				} else {
					if (!isCrashed) {
						document.location.href = "/";
						alert("You lose :(");
					}
				}
			};
			$('#message').focus();
			$.connection.hub.start()
				.done(function() {
					$('#sendmessage')
						.click(function() {
							game.server.updatePlayer({
								key: $('#message').val()
							});
							$('#message').val('').focus();
							document.getElementById('sendmessage').disabled = true;
						});
				});
		});
	</script>
}